<!DOCTYPE html>
<html lang="en">
<head>
	<!--
	<meta http-equiv="X-Frame-Options" content="ALLOWAll">
	-->
	<meta charset="UTF-8">
	<style>
		body { margin:0;padding:0; }
		#test_video {}
	</style>
	<script>
		// ########################################################################
		var getParameters = function(paramName) {
			// 리턴값을 위한 변수 선언
			var returnValue;

			// 현재 URL 가져오기
			var url = location.href;

			// get 파라미터 값을 가져올 수 있는 ? 를 기점으로 slice 한 후 split 으로 나눔
			var parameters = (url.slice(url.indexOf('?') + 1, url.length)).split('&');

			// 나누어진 값의 비교를 통해 paramName 으로 요청된 데이터의 값만 return
			for(var i=0; i<parameters.length; i++) {
				var varName = parameters[i].split('=')[0];
				if (varName.toUpperCase() == paramName.toUpperCase()) {
					returnValue = parameters[i].split('=')[1];
					returnValue = decodeURIComponent(returnValue);
					if(returnValue.indexOf('└') > -1){
						returnValue = returnValue.split('└').join('=');
					}
					return decodeURIComponent(returnValue);
				}
			}
		};		
	</script>
</head>
<body> 
	<script src="http://localhost:8088/jquery-1.8.2.min.js"></script>
	<script src="http://localhost:8088/free.player.1.8.4.js"></script>
	<!--
	<video id="test_video" controls muted autoplay></video>
	-->
	<video id="test_video" controls muted autoplay poster="http://localhost:8088/idigitalu.png" style="background-color:#000000;width:100%;height:100%"></video>
	<br/>
	<div id="output"></div>
	<br/>
	<canvas style="display:none;"></canvas>

	<script type="text/javascript">
	<!--
		var fid;
		var proxyServerWs;
		var defaultProxyServerWs = "ws://127.0.0.1:30022/ws/";
		var point;
		var player;

		// ########################################################################
		$(function() {

		});

		// ########################################################################
		// ### iframe 메세지 통신(receive)
		window.addEventListener('message', function(e) {
			// ### Player 사이즈 조절
			// ### (사용안함) - <video 태그에 대해 사이즈를 100%로 지정하였으므로, parent iframe 사이즈에 따라 자동으로 조절됨.
			if(e._msgkey == 'resize') {
				var _cctvW = e._cctvW;
				var _cctvH = e._cctvH;

				/*		
				player.width = _cctvWw - 5;
				player.height = _cctvH - 5;
				*/

				/*
				$("#test_video").css('width', (_cctvWw - 5) + 'px');
				$("#test_video").css('height', (_cctvH - 5) + 'px');
				*/
			}
		});

		// ########################################################################
		// ### player 구동
		function set_url(url, w, h, tp, ws, poi) {
			/*
			// ### test url
			url = "rtsp://211.252.223.178/217/video1d";
			*/

			test_video.src = url;
			/*
			Streamedian.player('test_video', {socket:"ws://121.167.147.208:30022/ws/"});
			Streamedian.player('test_video', {socket:"ws://rtsp.seoul.go.kr:30022/ws/"});
			Streamedian.player('test_video', {socket:"ws://127.0.0.1:30022/ws/"});		
			*/

			/*
			// ############################################################
			// ver 1.8.2
			var sp = Streamedian.player('test_video', {socket : ws});		
			player = document.getElementById('test_video');
			// ############################################################
			*/

			// ver 1.8.4
			if(window.Streamedian) {
				let errHandler = function(err) { 
					alert(err.message);
				};

				let infHandler = function(inf) {
					let sourcesNode = document.getElementById("sourcesNode");
					let clients = inf.clients;
					sourcesNode.innerHTML = "";

					for(let client in clients) {
						clients[client].forEach((sources) => {
							let nodeButton = document.createElement("button");
							nodeButton.setAttribute('data', sources.url + ' ' + client);
							nodeButton.appendChild(document.createTextNode(sources.description));
							nodeButton.onclick =(event)=> {
								setPlayerSource(event.target.getAttribute('data'));
							};
							sourcesNode.appendChild(nodeButton);
						});
					}
				};

				var playerOptions = {
					socket : ws,
					redirectNativeMediaErrors : true,
					bufferDuration : 30,
					errorHandler : errHandler,
					infoHandler : infHandler
				};

				var html5Player = document.getElementById("test_video");
				var player = Streamedian.player('test_video', playerOptions);

				function setPlayerSource(newSource) {
					player.destroy();
					player = null;
					html5Player.src = newSource;
					player = Streamedian.player("test_video", playerOptions);
				}
			}
			
			
			// ### Player 사이즈 조절
			// ### (사용안함) - <video 태그에 대해 사이즈를 100%로 지정하였으므로, parent iframe 사이즈에 따라 자동으로 조절됨.
			if(tp = "s") {
				/*
				player.width = w - 5;
				player.height = h - 5;
				*/

				/*
				$("#test_video").css('width', (_cctvWw - 5) + 'px');
				$("#test_video").css('height', (_cctvH - 5) + 'px');
				*/
			}

			// ####################################################
			// ### 이 페이지를 콜한 페이지에 대하여
			// ####################################################
			// 1. CCTV Checker 에 의한 콜
			if(poi == "rtspcheck") {
				setTimeout(function() {
					/*
					console.log("cctvPlay.html sp.client.clientSM : " + objToString(sp.client.clientSM)); 
					*/
					var tracks = sp.client.clientSM.tracks;
					var started = sp.client.clientSM.started;

					if(
						(typeof tracks === "undefined" || tracks === undefined || tracks == null || tracks == "undefined" || tracks == "") 
						&& (typeof started === "undefined" || started === undefined || started == null || started == "undefined" || started == "")
					) {
						window.parent.postMessage({ ERR : 'play-error' + '|' + fid }, '*');
					}
					else {
						if(started == true) {
							/*
							alert(fid);
							*/
							var imageData = snapshot();
							if(imageData) {
								window.parent.postMessage({ ERR : 'play-success' + '|' + fid + '|' + imageData}, '*');
							}
						}
					}
				}, 1000 * 5);
			}
		}

		// ########################################################################
		window.onload = function() {
			/*
			alert(getParameters("cctvUrl"));
			*/
			fid = getParameters("fid");
			proxyServerWs = getParameters("ws");
			point = getParameters("point");

			if(typeof proxyServerWs === "undefined" || proxyServerWs === undefined || proxyServerWs == null || port == "undefined" || proxyServerWs == "") {
				proxyServerWs = defaultProxyServerWs;
			}

			if(typeof point === "undefined" || point === undefined || point == null || point == "undefined" || point == "") {
				point = "normal";
			}
			//alert(getParameters("cctvUrl"))
			set_url(getParameters("cctvUrl"), getParameters("w"), getParameters("h"), getParameters("tp"), proxyServerWs, point);

			/*
			window.parent.postMessage({ hello: 'parent' }, '*');
			*/
		}

		// ########################################################################
		var videoId = 'test_video';
		var scaleFactor = 0.25;
		var snapshots = [];

		function capture(video, scaleFactor) {
			if(scaleFactor == null) {
				scaleFactor = 1;
			}
			var w = video.videoWidth * scaleFactor;
			var h = video.videoHeight * scaleFactor;
			var cvas = document.createElement('canvas');
			cvas.width  = w;
			cvas.height = h;
			/*
			cvas.style.border = "1px solid red";
			*/
			var ctx = cvas.getContext('2d');
			ctx.drawImage(video, 0, 0, w, h);
			return cvas;
		} 

		function snapshot() {
			var video  = document.getElementById(videoId);
			var output = document.getElementById('output');
			var canvas = capture(video, scaleFactor);
			/*
			canvas.onclick = function(){
				window.open(this.toDataURL('image/png'));
				button.href = this.toDataURL('image/png');
			};
			*/
			/*
			console.log(canvas.toDataURL('image/png'));
			*/
			/*
			snapshots.unshift(canvas);
			output.innerHTML = '';
			for(var i=0; i<4; i++){
				output.appendChild(snapshots[i]);
			}
			*/
			output.appendChild(canvas);

			return canvas.toDataURL('image/png');
		}

		// ########################################################################
		function sleep(ms) {
			ts1 = new Date().getTime() + ms;
			do ts2 = new Date().getTime(); while(ts2 < ts1);
		}

		// ########################################################################
		var HttpClient = function() {
			this.get = function(aUrl, aCallback) {
				var anHttpRequest = new XMLHttpRequest();
				anHttpRequest.onreadystatechange = function() { 
					if(anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
						aCallback(anHttpRequest.responseText);
					else if(anHttpRequest.readyState == 4 && anHttpRequest.status == 404)
						aCallback("404");
				}

				anHttpRequest.open( "GET", aUrl, true );            
				anHttpRequest.send( null );
			}
		}

		// ########################################################################
		// ### 디버그 용
		function objToString (obj) {
			var str = '';
			for(var p in obj) {
				if(obj.hasOwnProperty(p)) {
					str += p + '::' + obj[p] + '\n';
				}
			}
			return str;
		}
		// ########################################################################
	//-->
	</script>
</body>
</html>